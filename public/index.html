<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TKAI QA – Opprett sesjon</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <canvas id="particles-canvas"></canvas>
  <div class="container">
    <header class="hero">
      <h1>Q<span class="amp">&</span>A</h1>
      <p class="tagline">Spørsmål &amp; svar for ditt neste foredrag</p>
    </header>

    <section id="create-section" class="card">
      <h2>Opprett ny sesjon</h2>
      <form id="create-form">
        <label for="title">Foredragstittel</label>
        <input type="text" id="title" placeholder="f.eks. AI i hverdagen" required maxlength="120">

        <label for="speaker">Foredragsholder</label>
        <input type="text" id="speaker" placeholder="Ditt navn" required maxlength="80">

        <div class="image-upload">
          <label>Profilbilde (valgfritt)</label>
          <div class="image-upload-area">
            <div class="image-preview" id="image-preview" onclick="document.getElementById('image-input').click()">
              <span class="image-preview-placeholder" id="image-placeholder">Last opp</span>
            </div>
            <input type="file" id="image-input" accept="image/*">
            <span class="image-upload-text">Klikk for å laste opp bilde</span>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Opprett sesjon</button>
      </form>
    </section>

    <section id="links-section" class="card" style="display: none;">
      <h2>Sesjonen er opprettet!</h2>
      <p class="session-title-display" id="session-title"></p>

      <div class="link-group">
        <label>Publikumslenke <span class="hint">(del med publikum)</span></label>
        <div class="link-box">
          <input type="text" id="audience-link" readonly>
          <button class="btn btn-small" onclick="copyLink('audience-link')">Kopier</button>
        </div>
      </div>

      <div class="link-group">
        <label>Foredragsholderlenke <span class="hint">(privat – for deg)</span></label>
        <div class="link-box">
          <input type="text" id="speaker-link" readonly>
          <button class="btn btn-small" onclick="copyLink('speaker-link')">Kopier</button>
        </div>
      </div>

      <div class="link-actions">
        <a id="go-audience" href="#" target="_blank" class="btn btn-secondary">Publikumsvisning</a>
        <a id="go-speaker" href="#" target="_blank" class="btn btn-primary">Foredragsholdervisning</a>
      </div>

      <p class="help-text">Del publikumslenken med salen — de kan stille spørsmål og stemme på andres. Bruk foredragsholdervisningen til å se spørsmål, fokusere ett av gangen på storskjerm, og markere som besvart.</p>

      <button class="btn btn-text" onclick="resetForm()">Opprett en ny sesjon</button>
    </section>

    <footer class="site-footer">utviklet av <a href="https://www.superponni.no" target="_blank" rel="noopener">Superponni.no</a></footer>
  </div>

  <script>
    const form = document.getElementById('create-form');
    const createSection = document.getElementById('create-section');
    const linksSection = document.getElementById('links-section');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const imagePlaceholder = document.getElementById('image-placeholder');
    let speakerImageBase64 = null;

    // Resize image to max 256x256 before upload
    function resizeImage(file, maxSize) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > h) { if (w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; } }
          else { if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; } }
          canvas.width = w;
          canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', 0.85));
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // Image upload preview
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const resized = await resizeImage(file, 256);
      speakerImageBase64 = resized;
      imagePreview.innerHTML = `<img src="${resized}" alt="Preview">`;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const speaker = document.getElementById('speaker').value.trim();

      const res = await fetch('/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, speaker, speakerImage: speakerImageBase64 }),
      });

      if (!res.ok) {
        alert('Noe gikk galt. Prøv igjen.');
        return;
      }

      const session = await res.json();
      const base = window.location.origin;
      const audienceUrl = `${base}/s/${session.slug}`;

      showSession(session.slug, session.title, session.speaker);
      localStorage.setItem('tkai-last-session', JSON.stringify({ slug: session.slug, title: session.title, speaker: session.speaker }));
    });

    function showSession(slug, title, speaker) {
      const base = window.location.origin;
      document.getElementById('session-title').textContent = `"${title}" av ${speaker}`;
      document.getElementById('audience-link').value = `${base}/s/${slug}`;
      document.getElementById('speaker-link').value = `${base}/s/${slug}/speaker`;
      document.getElementById('go-audience').href = `/s/${slug}`;
      document.getElementById('go-speaker').href = `/s/${slug}/speaker`;
      createSection.style.display = 'none';
      linksSection.style.display = 'block';
    }

    function copyLink(inputId) {
      const input = document.getElementById(inputId);
      input.select();
      navigator.clipboard.writeText(input.value);
      const btn = input.nextElementSibling;
      btn.textContent = 'Kopiert!';
      setTimeout(() => btn.textContent = 'Kopier', 2000);
    }

    function resetForm() {
      createSection.style.display = 'block';
      linksSection.style.display = 'none';
      form.reset();
      speakerImageBase64 = null;
      imagePreview.innerHTML = '<span class="image-preview-placeholder">Last opp</span>';
      localStorage.removeItem('tkai-last-session');
    }

    // Restore last session on page load
    const lastSession = JSON.parse(localStorage.getItem('tkai-last-session') || 'null');
    if (lastSession) {
      showSession(lastSession.slug, lastSession.title, lastSession.speaker);
    }
  </script>
  <script src="/js/version.js"></script>
  <script src="/js/particles.js"></script>
</body>
</html>
